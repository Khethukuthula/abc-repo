CREATE OR REPLACE PROCEDURE "SP_API_ME_AND_YOU_UNLIMITED_BUSINESSRULES" ("LEADS" NUMBER(38,0))RETURNS VARCHAR(16777216)LANGUAGE SQL EXECUTE AS OWNER AS 'BEGIN-- KYLE MOODLEY | 20230418 | CREATED PROCEDURE--HISTORY INSERT - VARIABLE IS LEAD VOLUMECALL DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.SP_API_ME_AND_YOU_UNLIMITED_HISTORY_INSERT(:LEADS);--AUTO RANK--CALL DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.SP_AUTORANK(11225,6);END;';


CREATE OR REPLACE PROCEDURE DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.SP_API_ME_AND_YOU_UNLIMITED_HISTORY_INSERT("LEADS" NUMBER(38,0))RETURNS VARCHAR(16777216)LANGUAGE SQL EXECUTE AS OWNER AS '-- KYLE MOODLEY | 20230424 | CREATED PROCEDUREdeclare max integer; scoregroup varchar; leadsload integer;begin--======= LEADS STAGE TABLE CREATE OR REPLACE TABLE DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE AS SELECT * FROM DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.VW_IK_ME_AND_YOU_UNLIMITED_AUTOMATION_DATAPOOL; --======= SCOREBANDS STAGE TABLE CREATE OR REPLACE TABLE DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE_BANDS AS WITH MAIN AS ( select COUNT(1) as LEADS, SCOREGROUP from DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE A group by SCOREGROUP order by SCOREGROUP ), TOTAL AS ( SELECT SUM(LEADS) AS TOTALLEADS FROM MAIN ) SELECT ROW_NUMBER () OVER (PARTITION BY ''SCOREGROUP'' ORDER BY SCOREGROUP) AS IDENTITY, SCOREGROUP, LEADS, round(LEADS/(SELECT TOTALLEADS FROM TOTAL)*100,2) AS PERCENTAGE, round(LEADS/(SELECT TOTALLEADS FROM TOTAL)*(:LEADS),0) AS LEADSTOLOAD FROM MAIN;--======= HLL MAIN INSERT SELECT max(IDENTITY) into :max FROM DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE_BANDS; LET counter := 1; WHILE (counter <= max) DO select SCOREGROUP, LEADSTOLOAD into :scoregroup,leadsload from DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE_BANDS where IDENTITY = :counter; insert into DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TM_HLL_HISTORYLEADSLOADED ( IDNUMBER, CAMPAIGNID, BATCHNAME, CREATEDONDATE, LEADEXPIRY, DATATYPE, CUSTOMERNAME, LASTNAME, CELLNUMBER, CONTACTNUMBER1, SCORE, SCOREGROUP ) select a.idnumber, a.campaignid, a.batchname, a.createdondate, a.leadexpiry, a.datatype, a.customername, a.lastname, a.phone_number1, a.contactnumber1, a.score, a.scoregroup from DATAWAREHOUSE.DISTRIBUTION_DATA_APPLICATION.TS_API_ME_AND_YOU_UNLIMITED_STAGE A where A.SCOREGROUP =: scoregroup and A.SCOREGROUPROWNUM <=: leadsload; counter := counter + 1; end while; return counter-1;end;';